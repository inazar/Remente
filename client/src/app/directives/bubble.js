angular.module('Remente').directive('rementeBubble', [
  '$timeout', function($timeout) {
    return {
      restrict: 'EA',
      replace: true,
      transclude: 'element',
      template: "<div class=\"on-boarding-pane\" style=\"{{align}}\";>\n  <span style=\"display:inline-block;width:320px;position:{{position}};{{params.valign}}:0;height:{{params.height}}px;\">\n    <div style=\"height:0;width:0;\"></div>\n    <div ng-transclude class=\"text-center\" style=\"position:{{position}};left:{{params.box[0]}}px;{{params.valign}}:{{params.box[1]}}px;width:{{params.box[2]}}px;height:{{params.box[3]}}px;\"></div>\n  </span>\n</div>",
      scope: {
        step: '@'
      },
      link: function($scope, $element, $attrs, $ctrl, $transclude) {
        var obj, paper, _path;
        _path = [
          {
            align: 'center',
            valign: 'top',
            path: "M160.5,334 C238.096011,334 301,288.333047 301,232 C301,175.666953 238.096011,130 160.5,130 C82.9039888,130 20,175.666953 20,232 C20,288.333047 82.9039888,334 160.5,334 Z",
            box: [40, 160, 240, 175]
          }, {
            align: 'left',
            valign: 'top',
            path: "M185,431 C115.964403,431 60,391.824918 60,343.5 C60,323.538578 69.5488834,305.138339 85.6238722,290.415164 L72.0195313,244.458803 L103.218231,277.324108 C125.139077,264.038236 153.728516,256 185,256 C254.035597,256 310,295.175082 310,343.5 C310,391.824918 254.035597,431 185,431 Z",
            box: [90, 285, 190, 140]
          }, {
            align: 'right',
            valign: 'top',
            path: "M163.5,323 C79.2765715,323 11,273.827362 11,213.169831 C11,152.512301 79.2765715,103.339663 163.5,103.339663 C191.275572,103.339663 217.3168,108.687568 239.746105,118.03136 L271.689909,86.4048406 L266.315999,132.054261 C296.846866,152.13781 316,181.042934 316,213.169831 C316,273.827362 247.723429,323 163.5,323 Z",
            box: [40, 125, 245, 190]
          }, {
            align: 'center',
            valign: 'top',
            path: "M160,394 C237.319869,394 300,334.677733 300,261.5 C300,188.322267 237.319869,129 160,129 C82.6801312,129 20,188.322267 20,261.5 C20,334.677733 82.6801312,394 160,394 Z",
            box: [45, 160, 230, 175]
          }, {
            align: 'center',
            valign: 'top',
            path: "M160.5,146 C87.322267,146 28,128.986822 28,108 C28,88.1856333 80.8791898,71.9133266 148.372486,70.1570403 L159.5,39 L170.610348,70.1089735 C239.064408,71.5902014 293,87.9886897 293,108 C293,128.986822 233.677733,146 160.5,146 Z M161,271 C207.944206,271 246,248.390381 246,220.5 C246,192.609619 207.944206,170 161,170 C114.055794,170 76,192.609619 76,220.5 C76,248.390381 114.055794,271 161,271 Z",
            box: [50, 95, 220, 185]
          }, {
            align: 'none',
            valign: 'bottom',
            height: 150,
            path: "M151.548749,81.9100198 C86.4542095,80.5193457 35,63.1825179 35,42 C35,19.9086089 90.9644029,2 160,2 C229.035597,2 285,19.9086089 285,42 C285,63.1825179 233.545791,80.5193457 168.451624,81.9100118 L160.471215,105.921669 Z",
            box: [60, 75, 200, 50]
          }, {
            align: 'right',
            valign: 'bottom',
            height: 250,
            path: "M160.5,178 C82.9039888,178 20,138.824918 20,90.5 C20,42.175082 82.9039888,3 160.5,3 C238.096011,3 301,42.175082 301,90.5 C301,118.503286 279.877082,143.434092 247.012818,159.449823 L259.289062,204.775992 L223.453299,168.74638 C204.516921,174.66702 183.133453,178 160.5,178 Z",
            box: [40, 65, 230, 230]
          }, {
            align: 'left',
            valign: 'top',
            path: "M160.5,419.178484 C84.0085584,419.178484 22,375.988028 22,322.709894 C22,298.939558 34.3430995,277.177224 54.8090264,260.362354 L38.4598257,223.499132 L69.8574753,249.76818 C94.1495548,235.110311 125.837773,226.241303 160.5,226.241303 C236.991442,226.241303 299,269.43176 299,322.709894 C299,375.988028 236.991442,419.178484 160.5,419.178484 Z",
            box: [40, 270, 240, 140]
          }
        ];
        $scope.params = obj = _path[$scope.step];
        $scope.align = (function() {
          switch (obj.align) {
            case 'left':
              return 'left:0';
            case 'right':
              return 'right:0';
            case 'center':
              return 'text-align:center;';
            default:
              return '';
          }
        })();
        $scope.position = obj.align === 'center' ? 'relative' : 'absolute';
        paper = Raphael($element.find('span').find('div')[0], 320, 440);
        return paper.path(obj.path).attr('fill', '#FFF').attr({
          'stroke-width': 1
        }).attr('stroke', '#515151').glow();
      }
    };
  }
]);
